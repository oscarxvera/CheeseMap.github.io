<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CheeseMap</title>

<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>

<style>
html,body{margin:0;height:100%;background:#0b1220;color:#fff;font-family:system-ui}
#map{position:fixed;inset:0}

/* Toolbar */
.toolbar{
  position:fixed;top:12px;left:12px;right:12px;
  z-index:10;
  background:rgba(15,27,51,.75);
  border-radius:16px;
  padding:10px;
  display:flex;
  gap:8px;
  align-items:center;
  backdrop-filter:blur(12px)
}
.toolbar.hidden{transform:translateY(-120%)}

/* Controls */
input,select,button{
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.15);
  color:#fff;
  border-radius:999px;
  padding:8px 12px;
}
button{cursor:pointer}

/* Toggle */
.toggle{
  position:fixed;
  top:90px;right:14px;
  z-index:11;
  background:rgba(15,27,51,.75);
  border-radius:999px;
  padding:8px 12px;
  cursor:pointer
}

/* Popup */
.pinImg{max-width:200px;border-radius:10px;margin-top:6px}
</style>
</head>

<body>
<div id="map"></div>

<div class="toolbar" id="toolbar">
  <strong>ðŸ§€ CheeseMap</strong>
  <input id="search" placeholder="Search addressâ€¦"/>
  <select id="style">
    <option value="streets">Streets</option>
    <option value="dark">Dark</option>
    <option value="satellite">Satellite</option>
  </select>
  <button id="doSearch">Search</button>
</div>

<div class="toggle" id="toggle">Hide</div>

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script>
/* ================= CONFIG ================= */
const MAPTILER_KEY = "GFG1w5G5FvDB4k9dRW1U";

const STYLES = {
  streets:`https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`,
  dark:`https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}`,
  satellite:`https://api.maptiler.com/maps/satellite/style.json?key=${MAPTILER_KEY}`
};

const CA_BOUNDS = [
  [-124.48,32.52],
  [-114.13,42.01]
];

/* ================= STATE ================= */
let map;
let markers=[];

/* ================= HELPERS ================= */
const $ = id=>document.getElementById(id);

const inCA=(lng,lat)=>
  lng>=CA_BOUNDS[0][0]&&lng<=CA_BOUNDS[1][0]&&
  lat>=CA_BOUNDS[0][1]&&lat<=CA_BOUNDS[1][1];

function applyBounds(){
  map.setMaxBounds(CA_BOUNDS);
  map.setMinZoom(5);
}

/* ================= MAP INIT ================= */
map=new maplibregl.Map({
  container:"map",
  style:STYLES.streets,
  bounds:CA_BOUNDS,
  fitBoundsOptions:{padding:40},
  pitch:45,
  bearing:-15
});

map.on("load",applyBounds);
map.on("style.load",applyBounds);

/* ================= SEARCH ================= */
async function searchAddress(){
  const q=$("search").value.trim();
  if(q.length<2) return;

  const url=`https://api.maptiler.com/geocoding/${encodeURIComponent(q)}.json?key=${MAPTILER_KEY}&country=us&limit=1`;
  const res=await fetch(url);
  if(!res.ok) return alert("Geocoding blocked â€“ check key origins");

  const data=await res.json();
  if(!data.features?.length) return alert("No results");

  const [lng,lat]=data.features[0].center;
  if(!inCA(lng,lat)) return alert("Outside California");

  dropPin(lng,lat,data.features[0].place_name);
}

/* ================= PINS ================= */
function dropPin(lng,lat,title){
  const el=document.createElement("div");
  el.style.cursor="pointer";

  const marker=new maplibregl.Marker(el)
    .setLngLat([lng,lat])
    .addTo(map);

  const popup=document.createElement("div");
  popup.innerHTML=`<strong>${title}</strong><br><input type="file" accept="image/*"/>`;

  popup.querySelector("input").onchange=e=>{
    const img=document.createElement("img");
    img.className="pinImg";
    img.src=URL.createObjectURL(e.target.files[0]);
    popup.appendChild(img);
  };

  marker.setPopup(new maplibregl.Popup({offset:25}).setDOMContent(popup));
  el.onclick=()=>map.flyTo({center:[lng,lat],zoom:17});

  markers.push(marker);
  map.flyTo({center:[lng,lat],zoom:17});
}

/* ================= UI ================= */
$("doSearch").onclick=searchAddress;
$("search").onkeydown=e=>e.key==="Enter"&&searchAddress();

$("style").onchange=e=>map.setStyle(STYLES[e.target.value]);

let hidden=false;
$("toggle").onclick=()=>{
  hidden=!hidden;
  $("toolbar").classList.toggle("hidden",hidden);
  $("toggle").textContent=hidden?"Show":"Hide";
  $("toggle").style.top=hidden?"14px":"90px";
};
</script>
</body>
</html>
