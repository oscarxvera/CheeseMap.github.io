

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Our Story Map</title>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />

  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(15,27,51,.92);
      --panel2: rgba(11,18,32,.62);
      --border: rgba(255,255,255,.12);
      --text:#eaf1ff;
      --muted:#9bb0d0;
      --accent:#6aa7ff;
      --accent2:#86ffcc;
      --danger:#ff6a7a;
      --shadow: 0 14px 40px rgba(0,0,0,.38);
      --shadow2: 0 18px 60px rgba(0,0,0,.48);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html, body {height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      overflow:hidden;
    }

    /* Map behind UI */
    #map{position:fixed; inset:0; z-index:0}

    /* Attribution styling */
    .maplibregl-ctrl-attrib{
      background: rgba(15,27,51,.75) !important;
      border: 1px solid rgba(255,255,255,.10) !important;
      border-radius: 12px !important;
      backdrop-filter: blur(10px);
    }

    /* Top bar */
    .topbarWrap{
      position:fixed;
      top:12px; left:12px; right:12px;
      z-index:10;
      pointer-events:none;
    }
    .topbar{
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      background: rgba(11,18,32,.58);
      border:1px solid var(--border);
      border-radius: 22px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      transition: transform .22s ease, opacity .22s ease;
    }
    .topbar.collapsed{
      transform: translateY(-120%);
      opacity: 0;
      pointer-events:none;
    }

    .brand{
      display:flex; gap:10px; align-items:center;
      font-weight:900;
      letter-spacing:.2px;
      padding-left:4px;
      white-space:nowrap;
      min-width: 160px;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:99px;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(106,167,255,.55);
      flex:0 0 auto;
    }
    .brand .sub{
      color: var(--muted);
      font-weight:700;
      font-size: 12px;
      margin-left:4px;
    }

    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      position:relative;
      width: 100%;
    }

    .searchWrap{
      position:relative;
      display:flex;
      align-items:center;
      gap:8px;
      min-width: min(560px, 62vw);
      max-width: min(820px, 72vw);
      flex: 1 1 auto;
    }
    .searchGroup{
      position:relative;
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .search{
      width:100%;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:11px 42px 11px 40px;
      color: var(--text);
      outline:none;
      transition: background .15s ease, border-color .15s ease;
    }
    .search:focus{
      background: rgba(255,255,255,.13);
      border-color: rgba(106,167,255,.35);
    }
    .searchIcon{
      position:absolute;
      left:14px;
      top:50%;
      transform: translateY(-50%);
      opacity:.85;
      font-size: 14px;
      pointer-events:none;
    }
    .clearBtn{
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-50%);
      border:none;
      background: rgba(255,255,255,.10);
      color: var(--text);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding:6px 9px;
      cursor:pointer;
      display:none;
    }
    .clearBtn.show{display:block}

    .select{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding:10px 10px;
      color: var(--text);
      outline:none;
      cursor:pointer;
      white-space:nowrap;
    }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: var(--accent);
      color:#071126;
      font-weight:900;
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn.ghost{
      background: rgba(255,255,255,.10);
      color: var(--text);
      font-weight:800;
    }
    .btn.danger{
      background: rgba(255,106,122,.22);
      border-color: rgba(255,106,122,.35);
      color: #ffe7ea;
    }
    .btn:active{transform: translateY(1px)}

    .togglePill{
      pointer-events:auto;
      position:fixed;
      right:14px;
      top:92px;
      z-index:11;
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(11,18,32,.62);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      cursor:pointer;
      user-select:none;
    }
    .togglePill .k{
      width:26px;height:26px;border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .togglePill span{
      font-weight:850;
      font-size: 12px;
      color: var(--text);
    }

    .dropdown{
      position:absolute;
      top:56px;
      right:0;
      width:min(660px, 94vw);
      background: rgba(15,27,51,.96);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index:11;
      backdrop-filter: blur(12px);
    }
    .dropdown.open{display:block}
    .dd-head{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .dd-head .muted{color:var(--muted); font-size:12px}
    .dd-item{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
    }
    .dd-item:hover{background: rgba(255,255,255,.06)}
    .dd-ico{
      width:30px; height:30px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      margin-top:1px;
    }
    .dd-title{font-weight:900; font-size:13px; line-height:1.2}
    .dd-sub{color: var(--muted); font-size:12px; margin-top:2px}
    .dd-actions{
      display:flex; gap:8px; padding:10px 12px; align-items:center;
      background: rgba(0,0,0,.12);
      border-top:1px solid rgba(255,255,255,.08);
    }

    /* Bottom search card */
    .searchCard{
      position:fixed;
      left:12px;
      right:12px;
      bottom:12px;
      z-index:10;
      display:none;
      background: rgba(15,27,51,.92);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding:12px;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .searchCard.open{display:flex}
    .searchCard .txt{display:flex; flex-direction:column; gap:2px; overflow:hidden}
    .searchCard .t1{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .searchCard .t2{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .searchCard .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    /* Auth modal + Center pin modal */
    .overlay{
      position:fixed; inset:0;
      z-index:70;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }
    .overlay.open{display:flex}

    .card{
      width:min(980px, 96vw);
      max-height: min(86vh, 720px);
      background: rgba(15,27,51,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .cardHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.10)
    }
    .cardTitle{
      font-weight:950;
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .pill{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      white-space:nowrap;
    }
    .pill.cat{border-color: rgba(106,167,255,.25)}
    .pill.owner{border-color: rgba(134,255,204,.22); color: rgba(230,255,245,.95)}
    .cardBody{
      padding:12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      user-select:none;
    }
    .tab.active{
      background: var(--accent);
      color:#071126;
      border-color: rgba(255,255,255,.16);
    }

    /* Pin modal layout */
    .pinTopMeta{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .pinMetaLeft{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:6px;
      flex: 1 1 auto;
    }
    .pinTitleLine{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      min-width:0;
    }
    .pinTitleText{
      font-weight:950;
      font-size: 18px;
      line-height:1.15;
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .pinAddress{
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
    }
    .pinActions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      flex: 0 0 auto;
    }

    /* Form fields */
    .fieldRow{display:flex; gap:10px; flex-wrap:wrap}
    .field{
      width:100%;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding:11px 12px;
      color: var(--text);
      outline:none;
      font-size: 13px;
    }
    .field:focus{border-color: rgba(106,167,255,.55)}
    .field.small{padding:10px 12px; font-size:13px}
    textarea.field{min-height: 96px; resize: vertical}

    /* Gallery */
    .gallery{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .galleryTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .galleryHint{color: var(--muted); font-size: 12px}
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    .tile{
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
      position:relative;
      aspect-ratio: 4/3;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .tile img{width:100%;height:100%;object-fit:cover;display:block}
    .tile .tag{
      position:absolute;
      left:8px;
      bottom:8px;
      right:8px;
      font-size:11px;
      line-height:1.25;
      padding:6px 8px;
      border-radius: 12px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .tag .u{font-weight:900}
    .tag .d{opacity:.9}
    .empty{
      padding:14px;
      border:1px dashed rgba(255,255,255,.16);
      border-radius: 14px;
      color: rgba(234,241,255,.75);
      background: rgba(0,0,0,.14);
      font-weight:900;
    }

    /* Carousel viewer */
    .viewer{
      position:fixed; inset:0;
      z-index:85;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background: rgba(0,0,0,.84);
      backdrop-filter: blur(10px);
    }
    .viewer.open{display:flex}
    .viewerCard{
      width:min(980px, 96vw);
      background: rgba(15,27,51,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .viewerHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .viewerStage{
      position:relative;
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 48vh;
    }
    .viewerStage img{
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
      display:block;
    }
    .viewerNav{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      pointer-events:none;
    }
    .viewerNav button{
      pointer-events:auto;
      width:40px;height:40px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.12);
      color: var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .viewerFoot{
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      background: rgba(0,0,0,.12);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .viewerFoot .line1{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .viewerFoot .who{font-size:12px;color:rgba(234,241,255,.86);font-weight:900}
    .viewerFoot .desc{font-size:12px;color:rgba(234,241,255,.80);line-height:1.35}

    /* Comments */
    .comments{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .commentList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .comment{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .comment .h{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .comment .a{font-weight:900; font-size:12px}
    .comment .t{color: var(--muted); font-size: 11px}
    .comment .b{font-size:13px; line-height:1.35; color: rgba(234,241,255,.92)}

    /* Context menu */
    .ctx{
      position:fixed;
      z-index:65;
      display:none;
      min-width: 220px;
      background: rgba(15,27,51,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .ctx.open{display:block}
    .ctx .item{
      padding:10px 12px;
      cursor:pointer;
      display:flex;align-items:center;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-weight:900;
      user-select:none;
    }
    .ctx .item:last-child{border-bottom:0}
    .ctx .item:hover{background: rgba(255,255,255,.06)}
    .ctx .sub{font-weight:800;color:var(--muted);font-size:12px;margin-left:auto}

    /* Auth overlay small */
    .authCard{width:min(520px, 96vw)}
    .note{color:var(--muted);font-size:12px;line-height:1.35}
    .error{color:#ffb3bb;font-size:12px;display:none}
    .error.show{display:block}

    @media (max-width: 960px){
      .grid{grid-template-columns: repeat(3, minmax(0, 1fr));}
    }
    @media (max-width: 720px){
      .dropdown{right:auto; left:0; width: calc(100vw - 24px);}
      .searchWrap{min-width: 100%; max-width: 100%;}
      .searchCard{flex-direction:column; align-items:stretch}
      .searchCard .actions{justify-content:stretch}
      .searchCard .actions .btn{flex:1}
      .brand{min-width:auto}
      .topbar{border-radius: 18px}
      .togglePill{top:124px;}
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .card{max-height: 88vh}
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- TOPBAR -->
  <div class="topbarWrap">
    <div class="topbar" id="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span>Our Story Map</span>
        <span class="sub">Memories</span>
      </div>

      <div class="controls">
        <select id="styleSel" class="select" title="Map style">
          <option value="streets">Streets</option>
          <option value="dark">Dark</option>
          <option value="satellite">Satellite</option>
          <option value="hybrid">Satellite + Labels</option>
        </select>

        <div class="searchWrap">
          <div class="searchGroup">
            <span class="searchIcon">ðŸ”Ž</span>
            <input id="search" class="search" type="text" placeholder="Search an address, city, or place..." autocomplete="off" />
            <button id="clearSearch" class="clearBtn" title="Clear">âœ•</button>
          </div>

          <button id="btnSearch" class="btn ghost" title="Search">Search</button>
          <div id="dropdown" class="dropdown"></div>
        </div>

        <button id="btnLocate" class="btn ghost">Locate</button>
        <button id="btnSignInTop" class="btn ghost">Sign in</button>
        <button id="btnHelp" class="btn ghost">Help</button>
      </div>
    </div>
  </div>

  <!-- Toolbar toggle -->
  <div class="togglePill" id="togglePill" title="Show/Hide toolbar">
    <div class="k" id="toggleIcon">âŒƒ</div>
    <span id="toggleText">Hide</span>
  </div>

  <!-- Search result card -->
  <div class="searchCard" id="searchCard">
    <div class="txt">
      <div class="t1" id="scTitle">Result</div>
      <div class="t2" id="scSub">Address</div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnAddPinFromResult" style="display:none;">Add pin here</button>
      <button class="btn ghost" id="btnClearResult">Clear</button>
    </div>
  </div>

  <!-- Context menu -->
  <div class="ctx" id="ctxMenu">
    <div class="item" id="ctxAddPin">ðŸ“Œ Add a pin here <span class="sub">Map</span></div>
    <div class="item" id="ctxOpenPin" style="display:none;">ðŸ—‚ Open pin <span class="sub">Pin</span></div>
    <div class="item" id="ctxDeletePin" style="display:none;">ðŸ—‘ Delete pin <span class="sub">Owner</span></div>
    <div class="item" id="ctxClose">âœ• Close</div>
  </div>

  <!-- AUTH OVERLAY -->
  <div class="overlay" id="authOverlay" aria-hidden="true">
    <div class="card authCard">
      <div class="cardHead">
        <div class="cardTitle">Sign in</div>
        <button class="btn ghost" id="authClose">âœ•</button>
      </div>
      <div class="cardBody">
        <div class="note">
          Sign in to add pins, upload photos, and comment/like memories.
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="tab active" id="tabSignIn">Sign in</button>
          <button class="tab" id="tabCreate">Create account</button>
        </div>

        <div class="error" id="authErr"></div>

        <input class="field" id="authEmail" type="email" placeholder="Email" autocomplete="email" />
        <input class="field" id="authPass" type="password" placeholder="Password" autocomplete="current-password" />

        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn ghost" id="btnGoogle">Continue with Google</button>
          <button class="btn" id="btnEmailAction">Sign in</button>
        </div>

        <div class="note">
          Make sure Email/Password and Google are enabled in Firebase Authentication â†’ Sign-in method,
          and add your domain under Authentication â†’ Settings â†’ Authorized domains.
        </div>
      </div>
    </div>
  </div>

  <!-- PIN MODAL -->
  <div class="overlay" id="pinOverlay" aria-hidden="true">
    <div class="card" id="pinCard">
      <div class="cardHead">
        <div class="cardTitle" style="min-width:0;">
          <span id="pmTitle">Memory</span>
          <span class="pill cat" id="pmCatPill" style="display:none;"></span>
          <span class="pill owner" id="pmOwnerPill" style="display:none;"></span>
        </div>
        <button class="btn ghost" id="pinClose">âœ•</button>
      </div>
      <div class="cardBody">
        <div class="pinTopMeta">
          <div class="pinMetaLeft">
            <div class="pinTitleLine">
              <div class="pinTitleText" id="pmTitleText">â€”</div>
            </div>
            <div class="pinAddress" id="pmAddress">â€”</div>
          </div>

          <div class="pinActions">
            <button class="btn ghost" id="pmLikeBtn">â™¡ Like</button>
            <button class="btn ghost" id="pmEditBtn" style="display:none;">Edit</button>
            <button class="btn danger" id="pmDeleteBtn" style="display:none;">Delete</button>
          </div>
        </div>

        <div class="tabs" id="pmTabs">
          <button class="tab active" data-tab="gallery">Gallery</button>
          <button class="tab" data-tab="story">Story</button>
          <button class="tab" data-tab="music">Music</button>
          <button class="tab" data-tab="comments">Comments</button>
        </div>

        <!-- TAB CONTENTS -->
        <div id="tab_gallery" class="tabPane">
          <div class="gallery">
            <div class="galleryTop">
              <div class="galleryHint" id="pmGalleryHint">Photos from everyone show here.</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
                <label class="btn" id="pmUploadLabel" style="display:none;">
                  Upload photos
                  <input id="pmUploadInput" type="file" accept="image/*" multiple style="display:none;" />
                </label>
                <button class="btn ghost" id="pmSignInForUpload" style="display:none;">Sign in to upload</button>
              </div>
            </div>

            <textarea class="field" id="pmPhotoDesc" placeholder="Optional description for the next upload (shows on all uploaded photos)..." style="display:none;min-height:58px;"></textarea>

            <div id="pmGalleryEmpty" class="empty" style="display:none;">No photos yet. Upload the first memory photo âœ¨</div>
            <div id="pmGrid" class="grid"></div>
          </div>
        </div>

        <div id="tab_story" class="tabPane" style="display:none;">
          <div class="fieldRow">
            <select id="pmCategory" class="field small" style="max-width: 320px;">
              <option value="">Category (optional)</option>
              <option value="First Date">First Date</option>
              <option value="First Fight">First Fight (lol)</option>
              <option value="Proposal">Proposal</option>
              <option value="Anniversary">Anniversary</option>
              <option value="Trip">Trip</option>
              <option value="Future Memory">Future Memory</option>
              <option value="Other">Other</option>
            </select>

            <input id="pmTitleEdit" class="field small" placeholder="Title (e.g., First Date at The Cafe)" style="flex:1;min-width:240px;" />
          </div>

          <textarea id="pmStoryEdit" class="field" placeholder="Write the memory story here... (short or long)"></textarea>

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn ghost" id="pmCancelEdit" style="display:none;">Cancel</button>
            <button class="btn" id="pmSaveEdit" style="display:none;">Save changes</button>
            <div class="note" id="pmStoryView" style="display:none;white-space:pre-wrap;"></div>
          </div>

          <div class="note" id="pmStoryNote" style="display:none;">
            Only the pin owner can edit title/category/story/music. Anyone can upload photos and comment (if signed in).
          </div>
        </div>

        <div id="tab_music" class="tabPane" style="display:none;">
          <div class="note" style="margin-bottom:8px;">
            Paste a YouTube / Spotify / Apple Music link. Weâ€™ll embed it.
          </div>

          <input id="pmMusicUrl" class="field small" placeholder="Music URL (YouTube/Spotify/Apple Music)" />

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn" id="pmSaveMusic" style="display:none;">Save music</button>
          </div>

          <div id="pmMusicEmbedWrap" style="margin-top:10px;display:none;">
            <div class="empty" style="border-style:solid;border-color:rgba(255,255,255,.10);">
              <div style="font-weight:950;margin-bottom:8px;">Music preview</div>
              <div id="pmMusicEmbed"></div>
            </div>
          </div>
        </div>

        <div id="tab_comments" class="tabPane" style="display:none;">
          <div class="comments">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between">
              <div class="note" id="pmLikeCount">Likes: 0</div>
              <button class="btn ghost" id="pmSignInForComment" style="display:none;">Sign in to comment</button>
            </div>

            <div id="pmCommentComposer" style="display:none;">
              <textarea id="pmCommentText" class="field" placeholder="Write a comment..." style="min-height:80px;"></textarea>
              <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
                <button class="btn" id="pmPostComment">Post comment</button>
              </div>
            </div>

            <div class="commentList" id="pmCommentList"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Carousel viewer -->
  <div class="viewer" id="viewer">
    <div class="viewerCard">
      <div class="viewerHead">
        <div style="font-weight:950">Photo</div>
        <button class="btn ghost" id="viewerClose">âœ•</button>
      </div>
      <div class="viewerStage">
        <img id="viewerImg" alt="Photo" />
        <div class="viewerNav">
          <button id="viewerPrev">â€¹</button>
          <button id="viewerNext">â€º</button>
        </div>
      </div>
      <div class="viewerFoot">
        <div class="line1">
          <span class="who" id="viewerWho"></span>
          <span class="pill" id="viewerWhen" style="display:none;"></span>
        </div>
        <div class="desc" id="viewerDesc"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <!-- ================= Firebase ================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      limit,
      serverTimestamp,
      deleteDoc,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // âœ… Your Firebase config (keep your values)
    const firebaseConfig = {
      apiKey: "AIzaSyArJ2PR7-YJpjtlsVnZaCUNireuVpdq6ZE",
      authDomain: "the-map-f43ff.firebaseapp.com",
      projectId: "the-map-f43ff",
      storageBucket: "the-map-f43ff.firebasestorage.app",
      messagingSenderId: "110766323620",
      appId: "1:110766323620:web:e3b0a9b995c088d12e7331",
      measurementId: "G-CYEC068G15"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // Expose minimal API to the non-module script
    window.__fb = {
      auth, db, storage, provider,
      signInWithPopup, signOut, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      doc, setDoc, getDoc, updateDoc, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp, deleteDoc, runTransaction,
      ref, uploadBytes, getDownloadURL, deleteObject
    };
  </script>

  <!-- ================= App Script ================= -->
  <script>
    /***********************
     * CONFIG
     ***********************/
    // âœ… MapTiler key
    const MAPTILER_KEY = "GFG1w5G5FvDB4k9dRW1U";

    // Map styles
    const STYLES = {
      streets:   https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY},
      dark:      https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY},
      satellite: https://api.maptiler.com/maps/satellite/style.json?key=${MAPTILER_KEY},
      hybrid:    https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}
    };

    // OPTIONAL: Keep California-only bounds (you can remove if you want global)
    const CA_BOUNDS = [
      [-124.482003, 32.528832],
      [-114.131211, 42.009518]
    ];

    const DEFAULT_CATEGORY = "Other";

    /***********************
     * UTIL
     ***********************/
    const $ = (id) => document.getElementById(id);
    const debounce = (fn, ms=250) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function formatTime(ts){
      try{
        if(!ts) return "";
        const d = (ts instanceof Date) ? ts : (ts.toDate ? ts.toDate() : new Date(ts));
        return d.toLocaleString(undefined, { month:"short", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit" });
      }catch{ return ""; }
    }

    function isInCA(lng, lat){
      return (
        lng >= CA_BOUNDS[0][0] && lng <= CA_BOUNDS[1][0] &&
        lat >= CA_BOUNDS[0][1] && lat <= CA_BOUNDS[1][1]
      );
    }

    function showGeocodeBlocked(status){
      alert(
        Geocoding blocked (${status}). Fix in MapTiler:\n\n +
        Key â†’ Allowed HTTP Origins must be EXACTLY one of:\n +
        â€¢ oscarxvera.github.io\n +
        OR\n +
        â€¢ https://oscarxvera.github.io\n\n +
        No paths, no duplicates.
      );
    }

    /***********************
     * FIREBASE HELPERS
     ***********************/
    async function ensureFirebaseReady(){
      const maxMs = 6000;
      const start = Date.now();
      while(!window.__fb){
        if(Date.now() - start > maxMs) break;
        await new Promise(r => setTimeout(r, 20));
      }
      return !!window.__fb;
    }
    function currentUser(){
      return window.__fb?.auth?.currentUser || null;
    }
    function colorFromUid(uid){
      if(!uid) return "#ffffff";
      let hash = 0;
      for (let i=0;i<uid.length;i++) { hash = ((hash<<5)-hash) + uid.charCodeAt(i); hash |= 0; }
      const hue = Math.abs(hash) % 360;
      return hsl(${hue} 85% 62%);
    }

    /***********************
     * MUSIC EMBED PARSER
     ***********************/
    function normalizeUrl(url){
      try{ return new URL(url); }catch{ return null; }
    }

    function youtubeIdFromUrl(u){
      // Supports:
      // - https://www.youtube.com/watch?v=ID
      // - https://youtu.be/ID
      // - https://www.youtube.com/shorts/ID
      try{
        const url = normalizeUrl(u);
        if(!url) return null;
        if(url.hostname.includes("youtu.be")){
          const id = url.pathname.replace("/", "").trim();
          return id || null;
        }
        if(url.hostname.includes("youtube.com")){
          if(url.pathname.startsWith("/watch")){
            return url.searchParams.get("v");
          }
          if(url.pathname.startsWith("/shorts/")){
            return url.pathname.split("/shorts/")[1]?.split(/[?&/]/)[0] || null;
          }
          if(url.pathname.startsWith("/embed/")){
            return url.pathname.split("/embed/")[1]?.split(/[?&/]/)[0] || null;
          }
        }
        return null;
      }catch{ return null; }
    }

    function spotifyEmbedUrl(u){
      // Converts open.spotify.com/{type}/{id} to open.spotify.com/embed/{type}/{id}
      try{
        const url = normalizeUrl(u);
        if(!url) return null;
        if(!url.hostname.includes("spotify.com")) return null;
        const parts = url.pathname.split("/").filter(Boolean);
        if(parts[0] === "embed") return url.toString();
        if(parts.length >= 2){
          const type = parts[0];
          const id = parts[1];
          return https://open.spotify.com/embed/${type}/${id};
        }
        return null;
      }catch{ return null; }
    }

    function appleMusicEmbedUrl(u){
      // Apple Music embed generally works if you use embed.music.apple.com link.
      // If user pastes music.apple.com, attempt to swap to embed.music.apple.com.
      try{
        const url = normalizeUrl(u);
        if(!url) return null;
        if(url.hostname === "embed.music.apple.com") return url.toString();
        if(url.hostname.endsWith("music.apple.com")){
          return https://embed.music.apple.com${url.pathname}${url.search};
        }
        return null;
      }catch{ return null; }
    }

    function musicEmbedMarkup(rawUrl){
      const u = (rawUrl || "").trim();
      if(!u) return { ok:false, html:"" };

      const yt = youtubeIdFromUrl(u);
      if(yt){
        const src = https://www.youtube.com/embed/${encodeURIComponent(yt)};
        return {
          ok:true,
          html: <iframe width="100%" height="420" src="${src}" title="YouTube" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius:14px;border:1px solid rgba(255,255,255,.12)"></iframe>
        };
      }

      const sp = spotifyEmbedUrl(u);
      if(sp){
        return {
          ok:true,
          html: <iframe style="border-radius:14px;border:1px solid rgba(255,255,255,.12)" src="${sp}" width="100%" height="352" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        };
      }

      const am = appleMusicEmbedUrl(u);
      if(am){
        return {
          ok:true,
          html: <iframe allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write" frameborder="0" height="450" style="width:100%;max-width:100%;overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.12)" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="${am}"></iframe>
        };
      }

      return { ok:false, html:"" };
    }

    /***********************
     * STATE
     ***********************/
    const state = {
      map: null,
      pins: new Map(), // pinId -> pinObject {id,lng,lat,title,address,category,story,musicUrl,ownerUid,ownerName,ownerColor,marker,createdAt,updatedAt}
      // Context menu
      ctx: { lngLat:null, pinId:null },
      // Search last selected result
      lastSearch: { name:"", full:"", lng:null, lat:null, placeType:"" },
      // Pin modal current
      modal: {
        open: false,
        pinId: null,
        // data caches
        photos: [],
        photoIndex: 0,
        likesCount: 0,
        likedByMe: false,
        comments: [],
        editing: false
      },
      // Auth
      authMode: "signin",
      authResolve: null
    };

    /***********************
     * UI HELPERS
     ***********************/
    function setToolbarCollapsed(collapsed){
      const topbar = $("topbar");
      topbar.classList.toggle("collapsed", collapsed);
      $("toggleIcon").textContent = collapsed ? "âŒ„" : "âŒƒ";
      $("toggleText").textContent = collapsed ? "Show" : "Hide";
      $("togglePill").style.top = collapsed ? "14px" : "92px";
      if (collapsed) closeDropdown();
    }

    function openOverlay(id){
      const el = $(id);
      if(!el) return;
      el.classList.add("open");
      el.setAttribute("aria-hidden","false");
    }
    function closeOverlay(id){
      const el = $(id);
      if(!el) return;
      el.classList.remove("open");
      el.setAttribute("aria-hidden","true");
    }

    function showAuthError(msg){
      const el = $("authErr");
      el.textContent = msg || "Something went wrong.";
      el.classList.add("show");
    }
    function hideAuthError(){
      const el = $("authErr");
      el.textContent = "";
      el.classList.remove("show");
    }

    function closeDropdown(){
      $("dropdown").classList.remove("open");
      $("dropdown").innerHTML = "";
    }

    function openSearchCard(feature){
      $("scTitle").textContent = feature?.name || "Result";
      $("scSub").textContent = feature?.full || "";
      $("searchCard").classList.add("open");

      // show add pin button when we have coords
      const hasCoords = typeof feature?.lng === "number" && typeof feature?.lat === "number";
      $("btnAddPinFromResult").style.display = hasCoords ? "inline-flex" : "none";
    }
    function closeSearchCard(){
      $("searchCard").classList.remove("open");
      $("btnAddPinFromResult").style.display = "none";
    }

    function openCtxMenu(x, y, lngLat, pinId=null){
      state.ctx.lngLat = lngLat || null;
      state.ctx.pinId = pinId || null;

      const menu = $("ctxMenu");
      menu.style.left = ${Math.min(x, window.innerWidth - 240)}px;
      menu.style.top  = ${Math.min(y, window.innerHeight - 180)}px;

      // Show pin-specific actions
      const hasPin = !!pinId;
      $("ctxOpenPin").style.display = hasPin ? "flex" : "none";
      // Only show delete if owner
      if(hasPin){
        const pin = state.pins.get(pinId);
        const user = currentUser();
        if(user && pin && pin.ownerUid === user.uid){
          $("ctxDeletePin").style.display = "flex";
        }
      }

      menu.classList.add("open");
    }
    function closeCtxMenu(){
      $("ctxMenu").classList.remove("open");
      state.ctx.lngLat = null;
      state.ctx.pinId = null;
    }

    function setTopSignInButton(){
      const u = currentUser();
      const btn = $("btnSignInTop");
      if(!btn) return;
      if(u){
        btn.textContent = "Sign out";
      } else {
        btn.textContent = "Sign in";
      }
    }

    /***********************
     * AUTH FLOW
     ***********************/
    function setAuthMode(mode){
      state.authMode = mode;
      $("tabSignIn").classList.toggle("active", mode === "signin");
      $("tabCreate").classList.toggle("active", mode === "create");
      $("btnEmailAction").textContent = mode === "signin" ? "Sign in" : "Create account";
      $("authPass").setAttribute("autocomplete", mode === "signin" ? "current-password" : "new-password");
      hideAuthError();
    }

    function openAuth(){
      openOverlay("authOverlay");
      setAuthMode("signin");
      $("authEmail").focus();
      return new Promise((resolve)=>{ state.authResolve = resolve; });
    }

    function closeAuth(ok=false){
      closeOverlay("authOverlay");
      hideAuthError();
      if(state.authResolve){ state.authResolve(ok); state.authResolve = null; }
    }

    async function requireAuth(){
      if(!await ensureFirebaseReady()){
        alert("Firebase not ready (window.__fb missing). Check your <script type='module'> block.");
        return false;
      }
      if(currentUser()) return true;
      const ok = await openAuth();
      return !!ok && !!currentUser();
    }

    /***********************
     * FIRESTORE DATA MODEL
     ***********************/
    // pins/{pinId}
    //  - id, title, address, lng, lat, category, story, musicUrl
    //  - ownerUid, ownerName, ownerColor
    //  - createdAt, updatedAt
    //
    // pins/{pinId}/photos/{photoId}
    //  - url, storagePath, description, createdAt, uploadedByUid, uploadedByName
    //
    // pins/{pinId}/comments/{commentId}
    //  - body, createdAt, authorUid, authorName
    //
    // pins/{pinId}/likes/{uid}
    //  - createdAt

    function pinIdFromLngLat(lng, lat){
      return `pin_${lng.toFixed(5)}_${lat.toFixed(5)}`
        .replaceAll(".", "_")
        .replaceAll("-", "m");
    }

    async function upsertPinDoc(pin, isNew=false){
      if(!await ensureFirebaseReady()) return;
      const { db, doc, setDoc, serverTimestamp } = window.__fb;

      const refDoc = doc(db, "pins", pin.id);
      const payload = {
        id: pin.id,
        title: pin.title || "Memory",
        address: pin.address || "",
        category: pin.category || DEFAULT_CATEGORY,
        story: pin.story || "",
        musicUrl: pin.musicUrl || "",
        lng: pin.lng,
        lat: pin.lat,
        ownerUid: pin.ownerUid || null,
        ownerName: pin.ownerName || "",
        ownerColor: pin.ownerColor || "#ffffff",
        updatedAt: serverTimestamp()
      };
      if(isNew) payload.createdAt = serverTimestamp();

      await setDoc(refDoc, payload, { merge:true });
    }

    async function getPinDoc(pinId){
      if(!await ensureFirebaseReady()) return null;
      const { db, doc, getDoc } = window.__fb;
      const snap = await getDoc(doc(db, "pins", pinId));
      return snap.exists() ? snap.data() : null;
    }

    async function loadAllPins(){
      if(!await ensureFirebaseReady()) return;
      const { db, collection, getDocs } = window.__fb;

      const snap = await getDocs(collection(db, "pins"));
      for (const d of snap.docs){
        const p = d.data();
        if(!p || typeof p.lng !== "number" || typeof p.lat !== "number") continue;

        // CA lock optional
        if(CA_BOUNDS && Array.isArray(CA_BOUNDS) && CA_BOUNDS.length === 2){
          if(!isInCA(p.lng, p.lat)) continue;
        }

        const id = p.id || d.id;
        if(state.pins.has(id)) continue;

        addPinMarker({
          id,
          lng: p.lng,
          lat: p.lat,
          title: p.title || "Memory",
          address: p.address || "",
          category: p.category || DEFAULT_CATEGORY,
          story: p.story || "",
          musicUrl: p.musicUrl || "",
          ownerUid: p.ownerUid || null,
          ownerName: p.ownerName || "",
          ownerColor: p.ownerColor || "#ffffff",
          fromDb: true
        });
      }
    }

    async function loadPhotos(pinId){
      if(!await ensureFirebaseReady()) return [];
      const { db, collection, getDocs, query, orderBy } = window.__fb;
      const col = collection(db, "pins", pinId, "photos");
      const q = query(col, orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ ...d.data(), __docId: d.id }));
    }

    async function loadComments(pinId){
      if(!await ensureFirebaseReady()) return [];
      const { db, collection, getDocs, query, orderBy, limit } = window.__fb;
      const col = collection(db, "pins", pinId, "comments");
      const q = query(col, orderBy("createdAt", "desc"), limit(80));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ ...d.data(), __docId: d.id }));
    }

    async function getLikesCount(pinId){
      if(!await ensureFirebaseReady()) return 0;
      const { db, collection, getDocs } = window.__fb;
      const col = collection(db, "pins", pinId, "likes");
      const snap = await getDocs(col);
      return snap.size || 0;
    }

    async function likedByMe(pinId){
      if(!await ensureFirebaseReady()) return false;
      const user = currentUser();
      if(!user) return false;
      const { db, doc, getDoc } = window.__fb;
      const snap = await getDoc(doc(db, "pins", pinId, "likes", user.uid));
      return snap.exists();
    }

    async function toggleLike(pinId){
      if(!await ensureFirebaseReady()) return;
      const user = currentUser();
      if(!user){
        await openAuth();
        if(!currentUser()) return;
      }
      const { db, doc, getDoc, setDoc, deleteDoc, serverTimestamp } = window.__fb;
      const likeRef = doc(db, "pins", pinId, "likes", currentUser().uid);
      const snap = await getDoc(likeRef);
      if(snap.exists()){
        await deleteDoc(likeRef);
      } else {
        await setDoc(likeRef, { createdAt: serverTimestamp() });
      }
    }

    async function addComment(pinId, body){
      if(!await ensureFirebaseReady()) return;
      const user = currentUser();
      if(!user){
        await openAuth();
        if(!currentUser()) return;
      }
      const { db, collection, addDoc, serverTimestamp } = window.__fb;
      const col = collection(db, "pins", pinId, "comments");
      await addDoc(col, {
        body: (body || "").trim(),
        createdAt: serverTimestamp(),
        authorUid: currentUser().uid,
        authorName: currentUser().displayName || currentUser().email || "Unknown"
      });
    }

    async function uploadPhotos(pin, files, description){
      if(!await ensureFirebaseReady()) throw new Error("Firebase not ready");
      const user = currentUser();
      if(!user) throw new Error("Not signed in");

      const { storage, ref, uploadBytes, getDownloadURL, db, collection, addDoc, serverTimestamp } = window.__fb;

      const desc = (description || "").trim();
      const uploads = [];

      for (const file of files){
        const fileExt = (file.name.split(".").pop() || "jpg").toLowerCase();
        const path = `pins/${pin.id}/${Date.now()}_${Math.random().toString(16).slice(2)}.${fileExt}`;
        const sRef = ref(storage, path);

        await uploadBytes(sRef, file);
        const url = await getDownloadURL(sRef);

        const photosCol = collection(db, "pins", pin.id, "photos");
        await addDoc(photosCol, {
          url,
          storagePath: path,
          uploadedByUid: user.uid,
          uploadedByName: user.displayName || user.email || "Unknown",
          description: desc,
          createdAt: serverTimestamp()
        });

        uploads.push(url);
      }

      return uploads;
    }

    async function deletePinEverywhere(pin){
      if(!await ensureFirebaseReady()) return false;
      const user = currentUser();
      if(!user) return false;
      if(pin.ownerUid !== user.uid) return false;

      // Delete pin doc (photos/comments/likes are left as-is unless your rules/cleanup handle them)
      // If you want full cleanup, you need Cloud Functions or manual cleanup.
      const { db, doc, deleteDoc } = window.__fb;
      await deleteDoc(doc(db, "pins", pin.id));

      // Remove marker
      try{ pin.marker?.remove(); }catch{}
      state.pins.delete(pin.id);
      return true;
    }

    /***********************
     * MAP / MARKERS
     ***********************/
    function makeMarkerEl(color){
      const el = document.createElement("div");
      el.style.width = "18px";
      el.style.height = "18px";
      el.style.borderRadius = "999px";
      el.style.background = color || "#ffffff";
      el.style.border = "2px solid rgba(255,255,255,.95)";
      el.style.boxShadow = "0 10px 22px rgba(0,0,0,.35)";
      el.style.cursor = "pointer";
      return el;
    }

    function addPinMarker(pinData){
      const map = state.map;
      const id = pinData.id || pinIdFromLngLat(pinData.lng, pinData.lat);
      if(state.pins.has(id)) return state.pins.get(id);

      const ownerUid = pinData.ownerUid ?? currentUser()?.uid ?? null;
      const ownerName = pinData.ownerName ?? (currentUser()?.displayName || currentUser()?.email || "") ?? "";
      const ownerColor = pinData.ownerColor ?? colorFromUid(ownerUid);

      const pin = {
        id,
        lng: pinData.lng,
        lat: pinData.lat,
        title: pinData.title || "Memory",
        address: pinData.address || "",
        category: pinData.category || DEFAULT_CATEGORY,
        story: pinData.story || "",
        musicUrl: pinData.musicUrl || "",
        ownerUid,
        ownerName,
        ownerColor,
        marker: null
      };

      const markerEl = makeMarkerEl(ownerColor);
      const marker = new maplibregl.Marker({ element: markerEl })
        .setLngLat([pin.lng, pin.lat])
        .addTo(map);

      pin.marker = marker;
      state.pins.set(id, pin);

      // Left click: open pin modal
      markerEl.addEventListener("click", () => {
        openPinModal(id);
      });

      // Right click (or long press on mobile via dblclick handler below): open context menu on the pin
      markerEl.addEventListener("contextmenu", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        openCtxMenu(ev.clientX, ev.clientY, { lng: pin.lng, lat: pin.lat }, id);
      });

      // Mobile fallback: double tap pin to open context menu
      markerEl.addEventListener("dblclick", (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        openCtxMenu(ev.clientX, ev.clientY, { lng: pin.lng, lat: pin.lat }, id);
      });

      // Persist pin doc if new
      if(!pinData.fromDb){
        upsertPinDoc(pin, true).catch(()=>{});
      }

      return pin;
    }

    function applyBoundsAndZoomLock(){
      if(!state.map) return;
      if(CA_BOUNDS && Array.isArray(CA_BOUNDS) && CA_BOUNDS.length === 2){
        state.map.setMaxBounds(CA_BOUNDS);
        state.map.setMinZoom(5);
        state.map.setMaxZoom(20);
      } else {
        state.map.setMaxZoom(20);
      }
    }

    function initMap(){
      state.map = new maplibregl.Map({
        container: "map",
        style: STYLES.streets,
        bounds: (CA_BOUNDS && Array.isArray(CA_BOUNDS) ? CA_BOUNDS : undefined),
        fitBoundsOptions: { padding: 40, maxZoom: 12 },
        pitch: 45,
        bearing: -15,
        antialias: true
      });

      state.map.on("load", async () => {
        applyBoundsAndZoomLock();
        await loadAllPins().catch(console.error);

        // Right click map to open menu
        state.map.on("contextmenu", (e) => {
          const { lng, lat } = e.lngLat;

          if(CA_BOUNDS && Array.isArray(CA_BOUNDS) && CA_BOUNDS.length === 2){
            if(!isInCA(lng, lat)) return;
          }

          openCtxMenu(e.originalEvent.clientX, e.originalEvent.clientY, e.lngLat, null);
        });

        state.map.on("click", () => closeCtxMenu());
      });

      state.map.on("style.load", () => {
        applyBoundsAndZoomLock();
        // Markers remain because they are DOM markers; no need to re-add.
      });
    }

    /***********************
     * GEOCODING (MAPTILER)
     ***********************/
    async function maptilerSearch(queryText){
      const q = (queryText || "").trim();
      if (q.length < 2) { closeDropdown(); return; }

      const dd = $("dropdown");
      dd.innerHTML = "";
      dd.classList.add("open");

      const head = document.createElement("div");
      head.className = "dd-head";
      head.innerHTML = `
        <div class="muted">Searchingâ€¦</div>
        <button class="btn ghost" id="ddCloseBtn" style="padding:7px 10px;">Close</button>
      `;
      dd.appendChild(head);
      setTimeout(() => {
        const b = $("ddCloseBtn");
        if (b) b.onclick = () => closeDropdown();
      }, 0);

      const caCenterLng = -119.4179;
      const caCenterLat = 36.7783;

      const url =
        `https://api.maptiler.com/geocoding/${encodeURIComponent(q)}.json` +
        `?key=${MAPTILER_KEY}` +
        `&limit=10` +
        `&country=us` +
        `&autocomplete=true` +
        `&language=en` +
        `&proximity=${caCenterLng},${caCenterLat}`;

      let res, data;
      try{
        res = await fetch(url, { headers: { "Accept": "application/json" }});

        if (!res.ok){
          const text = await res.text().catch(()=> "");
          console.error("Geocoding failed:", res.status, text);

          head.querySelector(".muted").textContent = "Blocked";

          const row = document.createElement("div");
          row.className = "dd-item";
          row.innerHTML = `
            <div style="width:100%">
              <div class="dd-title">Search is blocked</div>
              <div class="dd-sub">Status: ${res.status}. Open DevTools â†’ Console for the MapTiler error.</div>
            </div>
          `;
          dd.appendChild(row);

          if (res.status === 401 || res.status === 403) showGeocodeBlocked(res.status);
          return;
        }

        data = await res.json();
      } catch (e){
        head.querySelector(".muted").textContent = "Error";
        console.error("Geocoding network error:", e);

        const row = document.createElement("div");
        row.className = "dd-item";
        row.innerHTML = `
          <div style="width:100%">
            <div class="dd-title">Network error</div>
            <div class="dd-sub">Couldnâ€™t reach MapTiler. Check internet + key restrictions.</div>
          </div>
        `;
        dd.appendChild(row);
        return;
      }

      const feats = Array.isArray(data?.features) ? data.features : [];
      head.querySelector(".muted").textContent = "Results";

      if (!feats.length){
        const none = document.createElement("div");
        none.className = "dd-item";
        none.innerHTML = `
          <div style="width:100%">
            <div class="dd-title">No matches</div>
            <div class="dd-sub">Try adding city + ZIP (example: â€œ123 Main St, Fresno CA 93722â€).</div>
          </div>
        `;
        dd.appendChild(none);
        return;
      }

      for (const f of feats){
        const coords = f.center || f.geometry?.coordinates;
        if (!coords || typeof coords[0] !== "number" || typeof coords[1] !== "number") continue;

        const lng = coords[0];
        const lat = coords[1];

        const placeName =
          f.place_name ||
          f.text ||
          f.properties?.name ||
          "Result";

        const nameTop = (f.text || placeName).split(",")[0] || placeName;
        const placeType = (f.place_type && f.place_type[0]) ? f.place_type[0] : "";

        let inBounds = true;
        if(CA_BOUNDS && Array.isArray(CA_BOUNDS) && CA_BOUNDS.length === 2){
          inBounds = isInCA(lng, lat);
        }

        const row = document.createElement("div");
        row.className = "dd-item";
        row.innerHTML = `
          <div class="dd-ico">ðŸ“</div>
          <div style="min-width:0; width:100%;">
            <div class="dd-title">
              ${escapeHtml(nameTop)}
              ${inBounds ? "" : `<span style="color:var(--danger); font-weight:900; margin-left:8px; font-size:12px;">Outside bounds</span>`}
            </div>
            <div class="dd-sub">${escapeHtml(placeName)}</div>
          </div>
        `;

        row.onclick = () => {
          closeDropdown();

          $("search").value = placeName;
          $("clearSearch").classList.add("show");

          state.lastSearch = { name: nameTop, full: placeName, lng, lat, placeType };

          // Zoom
          const zoom = (placeType === "address") ? 18.2 : 15.6;
          state.map.flyTo({ center:[lng, lat], zoom, speed: 1.2, curve: 1.42 });

          // Show result card and enable "Add pin here"
          openSearchCard({ name: nameTop, full: placeName, lng, lat });

          // If outside bounds, just inform
          if(!inBounds){
            alert("That result is outside the map bounds.");
          }
        };

        dd.appendChild(row);
      }
    }

    function performSearch(){
      const q = ($("search").value || "").trim();
      maptilerSearch(q);
    }

    function locateMe(){
      if (!navigator.geolocation){
        alert("Geolocation not available in this browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;

          if(CA_BOUNDS && Array.isArray(CA_BOUNDS) && CA_BOUNDS.length === 2){
            if(!isInCA(longitude, latitude)){
              alert("Your location appears outside the map bounds.");
              return;
            }
          }

          state.map.flyTo({ center:[longitude, latitude], zoom: 14.5, speed: 1.2, curve: 1.42 });
        },
        () => alert("Couldnâ€™t get your location. Check browser permissions."),
        { enableHighAccuracy:true, timeout: 10000 }
      );
    }

    /***********************
     * PIN MODAL RENDERING
     ***********************/
    function setActiveTab(tabKey){
      // buttons
      document.querySelectorAll("#pmTabs .tab").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabKey);
      });
      // panes
      ["gallery","story","music","comments"].forEach(k => {
        const el = $(`tab_${k}`);
        if(el) el.style.display = (k === tabKey) ? "block" : "none";
      });
    }

    function openPinModal(pinId){
      const pin = state.pins.get(pinId);
      if(!pin) return;

      state.modal.open = true;
      state.modal.pinId = pinId;
      state.modal.photos = [];
      state.modal.photoIndex = 0;
      state.modal.comments = [];
      state.modal.likesCount = 0;
      state.modal.likedByMe = false;
      state.modal.editing = false;

      // Header
      $("pmTitle").textContent = pin.title || "Memory";
      $("pmTitleText").textContent = pin.title || "Memory";
      $("pmAddress").textContent = pin.address || "";

      // Pills
      const cat = (pin.category || DEFAULT_CATEGORY).trim();
      $("pmCatPill").style.display = cat ? "inline-flex" : "none";
      $("pmCatPill").textContent = cat || "";

      const owner = (pin.ownerName || "").trim();
      $("pmOwnerPill").style.display = owner ? "inline-flex" : "none";
      $("pmOwnerPill").textContent = owner ? `Owner: ${owner}` : "";

      // Owner actions
      const u = currentUser();
      const isOwner = !!u && (pin.ownerUid && pin.ownerUid === u.uid);
      $("pmEditBtn").style.display = isOwner ? "inline-flex" : "none";
      $("pmDeleteBtn").style.display = isOwner ? "inline-flex" : "none";

      // Story tab: show view mode by default
      $("pmStoryView").style.display = "block";
      $("pmStoryView").textContent = pin.story || "No story yet.";
      $("pmCancelEdit").style.display = "none";
      $("pmSaveEdit").style.display = "none";
      $("pmTitleEdit").style.display = "none";
      $("pmStoryEdit").style.display = "none";
      $("pmCategory").style.display = "none";
      $("pmStoryNote").style.display = "block";
      $("pmStoryNote").style.display = "block";
      $("pmStoryNote").style.opacity = 0.95;

      // Music tab
      $("pmMusicUrl").value = pin.musicUrl || "";
      renderMusicEmbed(pin.musicUrl || "");
      $("pmSaveMusic").style.display = isOwner ? "inline-flex" : "none";

      // Gallery actions
      const canUpload = !!u; // any signed in user can upload
      $("pmUploadLabel").style.display = canUpload ? "inline-flex" : "none";
      $("pmPhotoDesc").style.display = canUpload ? "block" : "none";
      $("pmSignInForUpload").style.display = canUpload ? "none" : "inline-flex";

      // Comments actions
      $("pmSignInForComment").style.display = u ? "none" : "inline-flex";
      $("pmCommentComposer").style.display = u ? "block" : "none";
      $("pmCommentText").value = "";

      // Like button
      renderLikeButton(false);

      // Default tab
      setActiveTab("gallery");

      // Open
      openOverlay("pinOverlay");

      // Load content
      refreshModalData().catch(console.error);
    }

    function closePinModal(){
      closeOverlay("pinOverlay");
      state.modal.open = false;
      state.modal.pinId = null;
      state.modal.photos = [];
      state.modal.comments = [];
    }

    async function refreshModalData(){
      const pinId = state.modal.pinId;
      if(!pinId) return;

      const pin = state.pins.get(pinId);
      if(!pin) return;

      // Refresh pin doc (in case others updated)
      const docData = await getPinDoc(pinId);
      if(docData){
        pin.title = docData.title || pin.title;
        pin.address = docData.address || pin.address;
        pin.category = docData.category || pin.category;
        pin.story = docData.story || pin.story;
        pin.musicUrl = docData.musicUrl || pin.musicUrl;
        pin.ownerUid = docData.ownerUid || pin.ownerUid;
        pin.ownerName = docData.ownerName || pin.ownerName;
        pin.ownerColor = docData.ownerColor || pin.ownerColor;
      }

      // Update header
      $("pmTitle").textContent = pin.title || "Memory";
      $("pmTitleText").textContent = pin.title || "Memory";
      $("pmAddress").textContent = pin.address || "";
      const cat = (pin.category || DEFAULT_CATEGORY).trim();
      $("pmCatPill").style.display = cat ? "inline-flex" : "none";
      $("pmCatPill").textContent = cat || "";

      $("pmStoryView").textContent = pin.story || "No story yet.";
      $("pmMusicUrl").value = pin.musicUrl || "";
      renderMusicEmbed(pin.musicUrl || "");

      // Gallery
      state.modal.photos = await loadPhotos(pinId);
      renderGallery();

      // Likes
      state.modal.likesCount = await getLikesCount(pinId);
      state.modal.likedByMe = await likedByMe(pinId);
      $("pmLikeCount").textContent = `Likes: ${state.modal.likesCount}`;
      renderLikeButton(state.modal.likedByMe);

      // Comments
      state.modal.comments = await loadComments(pinId);
      renderComments();
    }

    function renderGallery(){
      const photos = state.modal.photos || [];
      const grid = $("pmGrid");
      grid.innerHTML = "";

      $("pmGalleryEmpty").style.display = photos.length ? "none" : "block";

      for(const [i, p] of photos.entries()){
        const tile = document.createElement("div");
        tile.className = "tile";
        tile.innerHTML = `
          <img src="${escapeHtml(p.url)}" alt="Photo"/>
          <div class="tag">
            <div class="u">${escapeHtml(p.uploadedByName || "Unknown")}</div>
            <div class="d">${escapeHtml((p.description || "").slice(0, 80))}</div>
          </div>
        `;
        tile.onclick = () => openViewer(i);
        grid.appendChild(tile);
      }
    }

    function openViewer(index){
      state.modal.photoIndex = index || 0;
      renderViewer();
      $("viewer").classList.add("open");
    }
    function closeViewer(){
      $("viewer").classList.remove("open");
    }
    function renderViewer(){
      const photos = state.modal.photos || [];
      if(!photos.length) return;

      const i = Math.max(0, Math.min(state.modal.photoIndex, photos.length-1));
      state.modal.photoIndex = i;

      const p = photos[i];
      $("viewerImg").src = p.url;
      $("viewerWho").textContent = `Uploaded by ${p.uploadedByName || "Unknown"}`;

      const when = formatTime(p.createdAt);
      $("viewerWhen").style.display = when ? "inline-flex" : "none";
      $("viewerWhen").textContent = when || "";

      $("viewerDesc").textContent = (p.description || "").trim() ? p.description.trim() : "";
    }

    function renderMusicEmbed(url){
      const wrap = $("pmMusicEmbedWrap");
      const target = $("pmMusicEmbed");
      const val = (url || "").trim();
      if(!val){
        wrap.style.display = "none";
        target.innerHTML = "";
        return;
      }
      const res = musicEmbedMarkup(val);
      if(!res.ok){
        wrap.style.display = "block";
        target.innerHTML = `<div class="note">Couldnâ€™t embed that link. Try YouTube / Spotify / Apple Music.</div>`;
        return;
      }
      wrap.style.display = "block";
      target.innerHTML = res.html;
    }

    function renderLikeButton(liked){
      const btn = $("pmLikeBtn");
      btn.textContent = liked ? "â™¥ Liked" : "â™¡ Like";
      btn.classList.toggle("ghost", true);
    }

    function renderComments(){
      const list = $("pmCommentList");
      list.innerHTML = "";
      const comments = state.modal.comments || [];
      if(!comments.length){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "No comments yet. Be the first ðŸ’¬";
        list.appendChild(empty);
        return;
      }
      comments.forEach(c => {
        const el = document.createElement("div");
        el.className = "comment";
        el.innerHTML = `
          <div class="h">
            <div class="a">${escapeHtml(c.authorName || "Unknown")}</div>
            <div class="t">${escapeHtml(formatTime(c.createdAt))}</div>
          </div>
          <div class="b">${escapeHtml(c.body || "")}</div>
        `;
        list.appendChild(el);
      });
    }

    /***********************
     * EDITING (OWNER)
     ***********************/
    function beginEdit(){
      const pin = state.pins.get(state.modal.pinId);
      if(!pin) return;

      state.modal.editing = true;

      $("pmTitleEdit").style.display = "block";
      $("pmStoryEdit").style.display = "block";
      $("pmCategory").style.display = "block";
      $("pmCancelEdit").style.display = "inline-flex";
      $("pmSaveEdit").style.display = "inline-flex";
      $("pmStoryView").style.display = "none";

      $("pmTitleEdit").value = pin.title || "";
      $("pmStoryEdit").value = pin.story || "";
      $("pmCategory").value = pin.category || DEFAULT_CATEGORY;
    }

    function cancelEdit(){
      state.modal.editing = false;
      $("pmTitleEdit").style.display = "none";
      $("pmStoryEdit").style.display = "none";
      $("pmCategory").style.display = "none";
      $("pmCancelEdit").style.display = "none";
      $("pmSaveEdit").style.display = "none";
      $("pmStoryView").style.display = "block";
    }

    async function saveEdit(){
      const pinId = state.modal.pinId;
      const pin = state.pins.get(pinId);
      if(!pin) return;

      const u = currentUser();
      if(!u || pin.ownerUid !== u.uid) return;

      const newTitle = ($("pmTitleEdit").value || "").trim() || "Memory";
      const newStory = ($("pmStoryEdit").value || "").trim();
      const newCat = ($("pmCategory").value || "").trim() || DEFAULT_CATEGORY;

      pin.title = newTitle;
      pin.story = newStory;
      pin.category = newCat;

      await upsertPinDoc(pin, false);

      // Refresh header + story
      $("pmTitle").textContent = pin.title;
      $("pmTitleText").textContent = pin.title;
      $("pmStoryView").textContent = pin.story || "No story yet.";
      $("pmCatPill").style.display = pin.category ? "inline-flex" : "none";
      $("pmCatPill").textContent = pin.category;

      cancelEdit();
    }

    async function saveMusic(){
      const pinId = state.modal.pinId;
      const pin = state.pins.get(pinId);
      if(!pin) return;

      const u = currentUser();
      if(!u || pin.ownerUid !== u.uid) return;

      const url = ($("pmMusicUrl").value || "").trim();
      pin.musicUrl = url;
      await upsertPinDoc(pin, false);
      renderMusicEmbed(url);
    }

    /***********************
     * CREATE PIN
     ***********************/
    async function createPinAt(lng, lat, addressText=""){
      const ok = await requireAuth();
      if(!ok) return;

      // Optional bounds check
      if(CA_BOUNDS && Array.isArray(CA_BOUNDS) && CA_BOUNDS.length === 2){
        if(!isInCA(lng, lat)){
          alert("That location is outside the map bounds.");
          return;
        }
      }

      const u = currentUser();
      const id = pinIdFromLngLat(lng, lat);
      const title = "New Memory";
      const category = DEFAULT_CATEGORY;

      const pin = addPinMarker({
        id,
        lng,
        lat,
        title,
        address: addressText || "",
        category,
        story: "",
        musicUrl: "",
        ownerUid: u.uid,
        ownerName: u.displayName || u.email || "Owner",
        ownerColor: colorFromUid(u.uid),
        fromDb: false
      });

      await upsertPinDoc(pin, true);

      // Open modal directly
      openPinModal(pin.id);
    }

    /***********************
     * UI WIRING
     ***********************/
    function wireUI(){
      // Toolbar toggle
      let collapsed = false;
      $("togglePill").onclick = () => {
        collapsed = !collapsed;
        setToolbarCollapsed(collapsed);
      };
      setToolbarCollapsed(false);

      // Style switch
      $("styleSel").addEventListener("change", () => {
        const v = $("styleSel").value;
        state.map.setStyle(STYLES[v] || STYLES.streets);
      });

      // Search typing
      $("search").addEventListener("input", debounce((e) => {
        const v = e.target.value;
        $("clearSearch").classList.toggle("show", !!v);
        maptilerSearch(v);
      }, 250));

      $("search").addEventListener("keydown", (e) => {
        if (e.key === "Enter"){
          e.preventDefault();
          performSearch();
        }
      });

      $("btnSearch").onclick = () => performSearch();

      $("clearSearch").onclick = () => {
        $("search").value = "";
        $("clearSearch").classList.remove("show");
        closeDropdown();
        closeSearchCard();
      };

      $("btnLocate").onclick = () => locateMe();

      $("btnHelp").onclick = () => {
        alert(
          "How to use:\n\n" +
          "â€¢ Search an address/city/place\n" +
          "â€¢ Click a result â†’ zoom\n" +
          "â€¢ Use 'Add pin here' (or right click map) to create a memory pin\n" +
          "â€¢ Click a pin â†’ open the memory modal in the center\n" +
          "â€¢ Gallery: everyone can upload photos (signed in)\n" +
          "â€¢ Story/Music: only the pin owner can edit\n" +
          "â€¢ Likes + Comments: signed-in users\n"
        );
      };

      // Search result card
      $("btnClearResult").onclick = () => closeSearchCard();
      $("btnAddPinFromResult").onclick = async () => {
        const { lng, lat, full } = state.lastSearch;
        if(typeof lng === "number" && typeof lat === "number"){
          await createPinAt(lng, lat, full || "");
        }
      };

      // Top sign-in
      $("btnSignInTop").onclick = async () => {
        const ok = await ensureFirebaseReady();
        if(!ok){
          alert("Firebase not ready.");
          return;
        }
        const { auth, signOut } = window.__fb;
        if(currentUser()){
          try{ await signOut(auth); } catch(e){ console.error(e); }
        } else {
          await openAuth();
        }
      };

      // Auth overlay
      $("authClose").onclick = () => closeAuth(false);
      $("tabSignIn").onclick = () => setAuthMode("signin");
      $("tabCreate").onclick = () => setAuthMode("create");

      $("btnGoogle").onclick = async () => {
        hideAuthError();
        const ok = await ensureFirebaseReady();
        if(!ok) return showAuthError("Firebase not ready.");
        const { auth, provider, signInWithPopup } = window.__fb;
        try{
          await signInWithPopup(auth, provider);
          closeAuth(true);
        } catch(e){
          console.error(e);
          showAuthError("Google sign-in failed. Check Firebase Auth settings + authorized domain.");
        }
      };

      $("btnEmailAction").onclick = async () => {
        hideAuthError();
        const ok = await ensureFirebaseReady();
        if(!ok) return showAuthError("Firebase not ready.");

        const email = ($("authEmail").value || "").trim();
        const pass  = ($("authPass").value || "").trim();
        if(!email || !pass) return showAuthError("Enter email + password.");

        const { auth, createUserWithEmailAndPassword, signInWithEmailAndPassword } = window.__fb;

        try{
          if(state.authMode === "create"){
            await createUserWithEmailAndPassword(auth, email, pass);
          } else {
            await signInWithEmailAndPassword(auth, email, pass);
          }
          closeAuth(true);
        } catch(e){
          console.error(e);
          const msg = (e?.code === "auth/email-already-in-use") ? "Email already in use. Try Sign in."
                    : (e?.code === "auth/invalid-credential") ? "Invalid email or password."
                    : (e?.code === "auth/weak-password") ? "Password too weak (try 6+ chars)."
                    : (e?.code === "auth/operation-not-allowed") ? "Enable Email/Password in Firebase Auth â†’ Sign-in method."
                    : "Auth failed. Check Firebase Authentication settings.";
          showAuthError(msg);
        }
      };

      // click outside auth closes
      $("authOverlay").addEventListener("click", (e) => {
        if(e.target && e.target.id === "authOverlay") closeAuth(false);
      });

      // Context menu actions
      $("ctxClose").onclick = () => closeCtxMenu();

      $("ctxAddPin").onclick = async () => {
        closeCtxMenu();
        const ll = state.ctx.lngLat;
        if(!ll) return;
        await createPinAt(ll.lng, ll.lat, "");
      };

      $("ctxOpenPin").onclick = () => {
        const pinId = state.ctx.pinId;
        closeCtxMenu();
        if(pinId) openPinModal(pinId);
      };

      $("ctxDeletePin").onclick = async () => {
        const pinId = state.ctx.pinId;
        closeCtxMenu();
        if(!pinId) return;
        const pin = state.pins.get(pinId);
        if(!pin) return;
        const ok = confirm("Delete this pin? (This removes the pin document. Photos may remain unless you clean them up.)");
        if(!ok) return;
        try{
          await deletePinEverywhere(pin);
          if(state.modal.pinId === pinId) closePinModal();
        }catch(e){
          console.error(e);
          alert("Could not delete pin. Check Firestore rules.");
        }
      };

      // Pin modal close
      $("pinClose").onclick = () => closePinModal();
      $("pinOverlay").addEventListener("click", (e) => {
        if(e.target && e.target.id === "pinOverlay") closePinModal();
      });

      // Tabs click
      $("pmTabs").addEventListener("click", (e) => {
        const btn = e.target.closest(".tab");
        if(!btn) return;
        const key = btn.dataset.tab;
        if(key) setActiveTab(key);
      });

      // Like
      $("pmLikeBtn").onclick = async () => {
        const pinId = state.modal.pinId;
        if(!pinId) return;
        try{
          await toggleLike(pinId);
          await refreshModalData();
        }catch(e){
          console.error(e);
        }
      };

      // Edit owner
      $("pmEditBtn").onclick = () => {
        setActiveTab("story");
        beginEdit();
      };
      $("pmCancelEdit").onclick = () => cancelEdit();
      $("pmSaveEdit").onclick = async () => {
        try{ await saveEdit(); }
        catch(e){ console.error(e); alert("Could not save. Check Firestore rules."); }
      };

      // Delete owner
      $("pmDeleteBtn").onclick = async () => {
        const pinId = state.modal.pinId;
        const pin = state.pins.get(pinId);
        if(!pin) return;
        const ok = confirm("Delete this pin?");
        if(!ok) return;
        try{
          await deletePinEverywhere(pin);
          closePinModal();
        }catch(e){
          console.error(e);
          alert("Could not delete pin. Check Firestore rules.");
        }
      };

      // Music save
      $("pmMusicUrl").addEventListener("input", debounce((e) => {
        renderMusicEmbed(e.target.value || "");
      }, 250));
      $("pmSaveMusic").onclick = async () => {
        try{ await saveMusic(); }
        catch(e){ console.error(e); alert("Could not save music. Check Firestore rules."); }
      };

      // Upload photos
      $("pmSignInForUpload").onclick = async () => {
        await openAuth();
        await refreshModalData();
      };
      $("pmUploadInput").onchange = async (e) => {
        const pinId = state.modal.pinId;
        const pin = state.pins.get(pinId);
        if(!pin) return;

        const files = Array.from(e.target.files || []);
        if(!files.length) return;

        try{
          if(!currentUser()){
            const ok = await openAuth();
            if(!ok || !currentUser()) return;
          }
          const desc = ($("pmPhotoDesc").value || "").trim();
          await uploadPhotos(pin, files, desc);
          $("pmPhotoDesc").value = "";
          e.target.value = "";
          await refreshModalData();
        } catch(err){
          console.error(err);
          alert("Upload failed. Check Storage rules + bucket.");
        }
      };

      // Comments
      $("pmSignInForComment").onclick = async () => {
        await openAuth();
        await refreshModalData();
      };
      $("pmPostComment").onclick = async () => {
        const pinId = state.modal.pinId;
        if(!pinId) return;
        const body = ($("pmCommentText").value || "").trim();
        if(!body) return;
        try{
          await addComment(pinId, body);
          $("pmCommentText").value = "";
          await refreshModalData();
        }catch(e){
          console.error(e);
          alert("Could not post comment. Check Firestore rules.");
        }
      };

      // Viewer
      $("viewerClose").onclick = () => closeViewer();
      $("viewer").addEventListener("click", (e) => {
        if(e.target && e.target.id === "viewer") closeViewer();
      });
      $("viewerPrev").onclick = () => {
        const photos = state.modal.photos || [];
        if(!photos.length) return;
        state.modal.photoIndex = (state.modal.photoIndex - 1 + photos.length) % photos.length;
        renderViewer();
      };
      $("viewerNext").onclick = () => {
        const photos = state.modal.photos || [];
        if(!photos.length) return;
        state.modal.photoIndex = (state.modal.photoIndex + 1) % photos.length;
        renderViewer();
      };

      // Global clicks: dropdown + ctx closing
      document.addEventListener("click", (ev) => {
        // Close dropdown if clicked outside searchWrap
        const dd = $("dropdown");
        const searchWrap = document.querySelector(".searchWrap");
        if (dd.classList.contains("open") && searchWrap && !searchWrap.contains(ev.target)) closeDropdown();

        // Close context menu if clicked outside it
        const ctx = $("ctxMenu");
        if (ctx.classList.contains("open") && !ctx.contains(ev.target)) closeCtxMenu();
      });

      // ESC closes overlays
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeDropdown();
          closeCtxMenu();
          if($("viewer").classList.contains("open")) closeViewer();
          if($("pinOverlay").classList.contains("open")) closePinModal();
          if($("authOverlay").classList.contains("open")) closeAuth(false);
        }
      });

      // Mobile-friendly: double tap map opens context menu
      state.map.on("dblclick", (e) => {
        const { lng, lat } = e.lngLat;
        if(CA_BOUNDS && Array.isArray(CA_BOUNDS) && CA_BOUNDS.length === 2){
          if(!isInCA(lng, lat)) return;
        }
        openCtxMenu(e.originalEvent.clientX, e.originalEvent.clientY, e.lngLat, null);
      });
    }

    /***********************
     * STARTUP
     ***********************/
    (async () => {
      initMap();
      wireUI();

      const ok = await ensureFirebaseReady();
      if(!ok) return;

      const { auth, onAuthStateChanged } = window.__fb;
      onAuthStateChanged(auth, async (user) => {
        setTopSignInButton();

        // If modal open, refresh so buttons update
        if(state.modal.open){
          await refreshModalData().catch(()=>{});
        }
      });

      setTopSignInButton();
    })();
  </script>
</body>
</html>
